<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Nutrient Calculator - Dark Mode & AI Chat Bar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        .icon-placeholder { display: inline-flex; align-items: center; justify-content: center; width: 1em; height: 1em; min-width: 1.2em; min-height: 1.2em; margin-right: 0.25em; padding: 0px 3px; border-radius: 0.125rem; font-size: 0.8em; font-weight: 600; vertical-align: middle;
            border: 1px solid var(--icon-placeholder-border-color, #cbd5e1); background-color: var(--icon-placeholder-bg-color, #f1f5f9); color: var(--icon-placeholder-text-color, #475569); }
        .dark .icon-placeholder { --icon-placeholder-border-color: #4b5563; --icon-placeholder-bg-color: #374151; --icon-placeholder-text-color: #d1d5db; }
        .toast-enter { opacity: 0; transform: translateX(100%); }
        .toast-enter-active { opacity: 1; transform: translateX(0); transition: opacity 300ms ease-out, transform 300ms ease-out; }
        .toast-exit { opacity: 1; transform: translateX(0); }
        .toast-exit-active { opacity: 0; transform: translateX(100%); transition: opacity 300ms ease-in, transform 300ms ease-in; }
        .loader { width: 16px; height: 16px; border-radius: 50%; display: inline-block; border-top: 2px solid #FFF; border-right: 2px solid transparent; box-sizing: border-box; animation: rotation 1s linear infinite; margin-right: 8px; }
        .dark .loader-gray { border-top: 2px solid #9ca3af; /* gray-400 for dark backgrounds */ }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 transition-colors duration-300">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root">
        <p style="padding: 20px; text-align: center;" class="text-slate-700 dark:text-slate-300">Loading Nutrient Calculator...</p>
    </div>

    <script type="text/babel">
        const IconPlaceholder = ({ name, className }) => ( <span title={name} className={`icon-placeholder ${className || ''}`}> {name ? name.charAt(0).toUpperCase() : '❖'} </span> );
        const Calculator = ({ className }) => <IconPlaceholder name="Calculator" className={className} />;
        const Droplets = ({ className }) => <IconPlaceholder name="Droplets" className={className} />;
        const Beaker = ({ className }) => <IconPlaceholder name="Beaker" className={className} />;
        const AlertCircle = ({ className }) => <IconPlaceholder name="AlertCircle" className={className} />;
        const CheckCircle = ({ className }) => <IconPlaceholder name="CheckCircle" className={className} />;
        const Plus = ({ className }) => <IconPlaceholder name="Plus" className={className} />;
        const Minus = ({ className }) => <IconPlaceholder name="Minus" className={className} />;
        const Download = ({ className }) => <IconPlaceholder name="Download" className={className} />;
        const Upload = ({ className }) => <IconPlaceholder name="Upload" className={className} />;
        const Settings = ({ className }) => <IconPlaceholder name="Settings" className={className} />;
        const Info = ({ className }) => <IconPlaceholder name="Info" className={className} />;
        const Target = ({ className }) => <IconPlaceholder name="Target" className={className} />;
        const Zap = ({ className }) => <IconPlaceholder name="Zap" className={className} />;
        const TrendingUp = ({ className }) => <IconPlaceholder name="TrendingUp" className={className} />;
        const BarChart3 = ({ className }) => <IconPlaceholder name="BarChart3" className={className} />;
        const Trash2 = ({ className }) => <IconPlaceholder name="Trash2" className={className} />;
        const ListPlus = ({ className }) => <IconPlaceholder name="ListPlus" className={className} />;
        const Edit = ({ className }) => <IconPlaceholder name="Edit" className={className} />;
        const Save = ({ className }) => <IconPlaceholder name="Save" className={className} />;
        const XCircle = ({ className }) => <IconPlaceholder name="X" className={className} />;
        const Water = ({ className }) => <IconPlaceholder name="Water" className={className} />;
        const MessageSquare = ({ className }) => <IconPlaceholder name="KI" className={className} />;
        const Key = ({ className }) => <IconPlaceholder name="Key" className={className} />;
        const Sun = ({ className }) => <IconPlaceholder name="Sun" className={className} />;
        const Moon = ({ className }) => <IconPlaceholder name="Moon" className={className} />;
        const Sparkles = ({className}) => <IconPlaceholder name="AI" className={className} />;

        const { useState, useEffect, useCallback, useMemo, useRef, useContext, createContext } = React;

        const ThemeContext = createContext();
        const ThemeProvider = ({ children }) => {
            const [theme, setTheme] = useState(() => {
                 if (typeof window !== 'undefined' && window.localStorage) {
                    const storedTheme = window.localStorage.getItem('theme');
                    if (storedTheme) return storedTheme;
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
                } return 'light'; 
            });
            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') { root.classList.add('dark'); document.body.classList.add('dark:bg-slate-900'); document.body.classList.remove('bg-white'); } 
                else { root.classList.remove('dark'); document.body.classList.add('bg-white'); document.body.classList.remove('dark:bg-slate-900'); }
                localStorage.setItem('theme', theme);
            }, [theme]);
            const toggleTheme = () => setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            return <ThemeContext.Provider value={{ theme, toggleTheme }}>{children}</ThemeContext.Provider>;
        };
        const useTheme = () => useContext(ThemeContext);

        const ToastContext = createContext(null);
        const ToastProviderInternal = ({ children }) => {
            const [toasts, setToasts] = useState([]); const toastIdRef = useRef(0);
            const removeToast = useCallback((id) => { setToasts(prevToasts => prevToasts.map(toast => toast.id === id ? { ...toast, exiting: true } : toast )); setTimeout(() => { setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id)); }, 300); }, []);
            const addToast = useCallback((message, type = 'info', duration = 3000) => { const id = toastIdRef.current++; setToasts(prevToasts => [{ id, message, type, duration, exiting: false }, ...prevToasts.slice(0,4) ]); if (duration && duration > 0) { setTimeout(() => removeToast(id), duration); } }, [removeToast]);
            return ( <ToastContext.Provider value={{ addToast, removeToast }}> {children} <ToastContainer toasts={toasts} /> </ToastContext.Provider> );
        };
        const ToastContainer = ({ toasts }) => ( <div className="fixed top-4 right-4 z-[10001] space-y-3 w-full max-w-xs sm:max-w-sm"> {toasts.map(toast => ( <ToastMessage key={toast.id} {...toast} /> ))} </div> );
        const ToastMessage = ({ id, message, type, exiting }) => {
            const { removeToast } = useContext(ToastContext); const [isVisible, setIsVisible] = useState(false);
            useEffect(() => { setIsVisible(true); }, []);
            const handleDismiss = useCallback(() => { removeToast(id); }, [id, removeToast]);
            let baseClasses = "p-4 rounded-md shadow-lg border w-full flex items-start text-sm"; 
            let typeClasses = "", IconComponent, buttonHoverFocusClasses = "";
            switch (type) { 
                case 'success': typeClasses = 'bg-green-100 text-green-800 border-green-400 dark:bg-green-800 dark:text-green-100 dark:border-green-600'; IconComponent = CheckCircle; buttonHoverFocusClasses = 'hover:bg-green-200 dark:hover:bg-green-700 focus:ring-green-600 focus:ring-offset-green-100 dark:focus:ring-offset-green-800'; break; 
                case 'error': typeClasses = 'bg-red-100 text-red-800 border-red-400 dark:bg-red-800 dark:text-red-100 dark:border-red-600'; IconComponent = AlertCircle; buttonHoverFocusClasses = 'hover:bg-red-200 dark:hover:bg-red-700 focus:ring-red-600 focus:ring-offset-red-100 dark:focus:ring-offset-red-800'; break; 
                case 'warning': typeClasses = 'bg-yellow-100 text-yellow-800 border-yellow-400 dark:bg-yellow-700 dark:text-yellow-100 dark:border-yellow-500'; IconComponent = AlertCircle; buttonHoverFocusClasses = 'hover:bg-yellow-200 dark:hover:bg-yellow-600 focus:ring-yellow-600 focus:ring-offset-yellow-100 dark:focus:ring-offset-yellow-700'; break; 
                case 'info': default: typeClasses = 'bg-blue-100 text-blue-800 border-blue-400 dark:bg-blue-800 dark:text-blue-100 dark:border-blue-600'; IconComponent = Info; buttonHoverFocusClasses = 'hover:bg-blue-200 dark:hover:bg-blue-700 focus:ring-blue-600 focus:ring-offset-blue-100 dark:focus:ring-offset-blue-800'; break; 
            }
            const animationClass = exiting ? 'toast-exit-active' : (isVisible ? 'toast-enter-active' : 'toast-enter');
            return ( <div className={`${baseClasses} ${typeClasses} ${animationClass}`} role="alert" aria-live={type === 'error' || type === 'warning' ? 'assertive' : 'polite'}> {IconComponent && <div className="flex-shrink-0 pt-0.5"><IconComponent className={`w-4 h-4`} /></div>} <div className="ml-3 flex-1 font-medium">{message}</div> <div className="ml-4 flex-shrink-0"> <button onClick={handleDismiss} className={`inline-flex rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-offset-2 ${buttonHoverFocusClasses}`}> <span className="sr-only">Dismiss</span> <XCircle className={`w-4 h-4`} /> </button> </div> </div> );
        };
        const useToasts = () => { const context = useContext(ToastContext); if (!context) { throw new Error('useToasts must be used within a ToastProviderInternal'); } return context.addToast; };
        
        const LOCAL_STORAGE_KEY_CUSTOM_FERTILIZERS = 'customFertilizers'; const LOCAL_STORAGE_KEY_CUSTOM_WATER = 'customWaterProfile'; const RECIPE_VERSION = "1.0.0";
        const TAB_BASIC = 'basic'; const TAB_ADVANCED = 'advanced'; const TAB_ANALYSIS = 'analysis'; const TAB_CUSTOM_FERTILIZER = 'customFertilizer'; const TAB_SETTINGS = 'settings';
        const LOCAL_STORAGE_KEY_GEMINI_API_KEY = 'geminiApiKey';
        // Remove hardcoded API key
        // const USER_PROVIDED_API_KEY = "AIzaSyAZJQgJYEv-7neMrMzhJXCFW_En3MgoDCY"; 

        const NUTRIENT_FIELDS = [ { key: 'n', label: 'N (Stickstoff)'},{ key: 'p', label: 'P (Phosphor)'},{ key: 'k', label: 'K (Kalium)'},{ key: 'ca', label: 'Ca (Calcium)'},{ key: 'mg', label: 'Mg (Magnesium)'},{ key: 's', label: 'S (Schwefel)'},{ key: 'b', label: 'B (Bor)'},{ key: 'cu', label: 'Cu (Kupfer)'},{ key: 'fe', label: 'Fe (Eisen)'},{ key: 'mn', label: 'Mn (Mangan)'},{ key: 'mo', label: 'Mo (Molybdän)'},{ key: 'zn', label: 'Zn (Zink)' }, { key: 'na', label: 'Na (Natrium)' }, { key: 'cl', label: 'Cl (Chlorid)' }, { key: 'no3', label: 'NO₃ (Nitrat)' }, { key: 'so4', label: 'SO₄ (Sulfat)' }, { key: 'po4', label: 'PO₄ (Phosphat)' } ];
        const BASE_FERTILIZER_DATABASE = { ta_calmg: { name: 'Terra Aquatica CaMg', type: 'liquid', composition: { n: 11.54, ca: 33.00, mg: 6.96 }, unit: 'ml'}, ta_finalpart: { name: 'Terra Aquatica FinalPart', type: 'liquid', composition: { p: 31.58, k: 50.06, mg: 21.82, s: 24.12 }, unit: 'ml'}, hesi_bloom: { name: 'Hesi Blüh Complex', type: 'liquid', composition: { n: 31.92, p: 12.07, k: 31.80, ca:0.11,mg:1.6,b:1.04,cu:0.21,fe:0.03,mn:1.7,mo:0.17,zn:0.74 }, unit: 'ml'}, hesi_tnt: { name: 'Hesi TNT Complex', type: 'liquid', composition: { n: 31.32, p: 10.48, k: 26.87, ca:0.1,mg:1.57,b:0.002,cu:0.005,fe:0.045,mn:0.011,mo:0.008,zn:0.009 }, unit: 'ml'}, bittersalz: { name: 'Bittersalz (MgSO4·7H2O)', type: 'powder', composition: { mg: 9.8, s: 13.0 }, unit: 'g'} };
        const GROWTH_STAGES = { seedling: { name: 'Keimling (1-2 W.)', n: [50, 100], p: [20, 40], k: [40, 80], ec: [0.4, 0.8] }, veg2: { name: 'Wachstum (5-6 W.)', n: [150, 200], p: [40, 60], k: [120, 160], ec: [1.2, 1.6] }, flower2: { name: 'Blüte (W. 4-5)', n: [100, 150], p: [100, 150], k: [250, 320], ec: [2.0, 2.4] }, flush: { name: 'Spülung (letzte W.)', n: [0, 20], p: [0, 10], k: [0, 20], ec: [0.2, 0.6] } };
        const WATER_TYPES = { ro: { name: 'RO/Destilliert', ca: 0, mg: 0, s:0, baseEC: 0}, medium: { name: 'Mittleres LW', ca: 60, mg: 15, s:8, baseEC: 0.3}, custom: { name: 'Eigenes Profil', ca:0, mg:0, s:0, baseEC:0 } };
        const initialCustomWaterProfile = { ca: 0, mg: 0, s: 0, na: 0, cl: 0, no3: 0, so4: 0, po4: 0, baseEC: 0.0 };
        const generateNewId = () => `custom_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;

        // Utility function for nutrient and EC calculation
        function calculateNutrientResults({ waterVolume, growthStage, waterType, selectedFertilizers, fertilizerDatabase, customWaterProfile, NUTRIENT_FIELDS, GROWTH_STAGES, WATER_TYPES }) {
          if (waterVolume <= 0) {
            return { nutrients: {}, contributions: {}, stage: GROWTH_STAGES[growthStage] };
          }
          let baseN = { ca: 0, mg: 0, s: 0, na: 0, cl: 0, no3: 0, so4: 0, po4: 0 };
          let currentEC = 0;
          if (waterType === 'custom') {
            baseN = {
              ca: customWaterProfile.ca||0,
              mg: customWaterProfile.mg||0,
              s: customWaterProfile.s||0,
              na: customWaterProfile.na||0,
              cl: customWaterProfile.cl||0,
              no3: customWaterProfile.no3||0,
              so4: customWaterProfile.so4||0,
              po4: customWaterProfile.po4||0
            };
            currentEC = customWaterProfile.baseEC||0;
          } else {
            const pWater = WATER_TYPES[waterType];
            baseN = { ca: pWater.ca||0, mg: pWater.mg||0, s: pWater.s||0, na: 0, cl: 0, no3: 0, so4: 0, po4: 0 };
            currentEC = pWater.baseEC !== undefined ? pWater.baseEC : 0;
          }
          let tN = NUTRIENT_FIELDS.reduce((acc,f) => {acc[f.key]=0; return acc;}, {});
          // Add new ions to tN
          tN.ca = baseN.ca; tN.mg = baseN.mg; tN.s = baseN.s;
          tN.na = baseN.na; tN.cl = baseN.cl; tN.no3 = baseN.no3; tN.so4 = baseN.so4; tN.po4 = baseN.po4;
          tN.ec = currentEC;
          let contrib = {};
          let nutrEC = 0;
          (selectedFertilizers||[]).forEach(fert => {
            if (!fert.active || !fert.amount || Number(fert.amount)===0) return;
            const fD = fertilizerDatabase[fert.id];
            if (!fD?.composition) return;
            const cFC = {};
            const fA = Number(fert.amount);
            Object.keys(fD.composition).forEach(nk => {
              const nC = Number(fD.composition[nk])||0;
              if (nC===0 || !NUTRIENT_FIELDS.find(field => field.key === nk)) return;
              let nVppm = (fD.type==='powder')?(fA*nC*10)/waterVolume:(fA*nC)/waterVolume;
              cFC[nk]=nVppm;
              tN[nk]=(tN[nk]||0)+nVppm;
            });
            contrib[fert.id]=cFC;
          });
          nutrEC = ((tN.n||0)-(baseN.n||0))*0.007+((tN.p||0)-(baseN.p||0))*0.005+((tN.k||0)-(baseN.k||0))*0.008+((tN.ca||0)-baseN.ca)*0.006+((tN.mg||0)-baseN.mg)*0.004+((tN.s||0)-baseN.s)*0.003;
          tN.ec = currentEC + Math.max(0, nutrEC);
          Object.keys(tN).forEach(k => { tN[k]=Math.round(tN[k]*100)/100; });
          return { nutrients:tN, contributions:contrib, stage:GROWTH_STAGES[growthStage] };
        }

        const ChatBar = ({ appData }) => {
            const [apiKey, setApiKey] = useState('');
            const [displayMessage, setDisplayMessage] = useState("Hallo! Ich bin dein KI-Helfer. Frag mich z.B. 'Wie erstelle ich einen Dünger?' oder 'Ist mein N-Wert ok?'");
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const addToast = useToasts();
            const inputRef = useRef(null);

            useEffect(() => { 
                const storedApiKey = localStorage.getItem(LOCAL_STORAGE_KEY_GEMINI_API_KEY);
                if (storedApiKey) {
                    setApiKey(storedApiKey);
                } else {
                    setDisplayMessage("Bitte API Key in den Einstellungen konfigurieren.");
                }
            }, []);
            
            const systemPrompt = `Du bist ein KI-Assistent für den "Cannabis Düngerrechner Pro". Antworte kurz und prägnant auf Deutsch.
Nutzer fragen dich Dinge über den Rechner oder Cannabis-Anbau.
Du erhältst mit jeder Anfrage die aktuellen Rechnerdaten. Beziehe dich darauf, wenn es passt.
Beispiel: Wenn Nutzer fragt "N-Wert ok?", vergleiche aktuellen N-Wert mit Zielbereich N aus den Daten.
Gib keine medizinischen Ratschläge oder fördere illegale Aktivitäten.
Antworte direkt auf die Frage.`;

            const generateAppStateString = (currentAppData) => { 
                if (!currentAppData) return "Keine App-Daten verfügbar.";
                let summary = `DATEN: Wasser:${currentAppData.waterVolume}L; Phase:${currentAppData.GROWTH_STAGES_DATA?.[currentAppData.growthStage]?.name || 'N/A'}; `;
                const stageDetails = currentAppData.GROWTH_STAGES_DATA?.[currentAppData.growthStage];
                if (stageDetails) { summary += `Ziel(N,P,K):${stageDetails.n?.join('-')},${stageDetails.p?.join('-')},${stageDetails.k?.join('-')}ppm; Ziel EC:${stageDetails.ec?.join('-')}mS; `; }
                summary += `Wassertyp:${currentAppData.WATER_TYPES_DATA?.[currentAppData.waterType]?.name||'N/A'}; `;
                if (currentAppData.results?.nutrients) { const r = currentAppData.results.nutrients; summary += `Aktuell(N,P,K):${r.n?.toFixed(0)},${r.p?.toFixed(0)},${r.k?.toFixed(0)}ppm; EC:${r.ec?.toFixed(1)}mS.`; }
                return summary.trim();
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                const userMessageText = inputValue.trim();
                if (!userMessageText) return;
                if (!apiKey) { addToast("API Key fehlt.", "warning"); return; }

                setIsLoading(true); setDisplayMessage("KI denkt nach...");

                const appStateContext = generateAppStateString(appData);
                const userMessageWithContext = `RECHNERDATEN:\n${appStateContext}\n\nNUTZERFRAGE:\n${userMessageText}`;

                let conversationHistory = [ { role: "user", parts: [{ text: systemPrompt }] }, { role: "model", parts: [{ text: "Verstanden." }] } ];
                if (appData.lastUserQueryForAI && appData.lastAIResponseForAI && appData.lastAIResponseForAI !== "Hallo! Ich bin dein KI-Helfer. Frag mich z.B. 'Wie erstelle ich einen Dünger?' oder 'Ist mein N-Wert ok?'") {
                    conversationHistory.push({ role: "user", parts: [{ text: appData.lastUserQueryForAI }] });
                    conversationHistory.push({ role: "model", parts: [{ text: appData.lastAIResponseForAI }] });
                }
                conversationHistory.push({ role: "user", parts: [{ text: userMessageWithContext }] });

                const finalGeminiContents = conversationHistory;


                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: finalGeminiContents, generationConfig: { temperature: 0.6, maxOutputTokens: 150 }, 
                            safetySettings: [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" } ]
                        })
                    });
                    
                    let botResponseText = "Fehler bei der Antwortgenerierung.";
                    if (!response.ok) {
                        const errorData = await response.json(); const errorMsg = errorData.error?.message || `API Fehler: ${response.status}`;
                        botResponseText = `AI Fehler: ${errorMsg}`; addToast(`API Fehler: ${errorMsg}`, "error", 6000);
                    } else {
                        const data = await response.json();
                        if (data.candidates?.[0]?.content?.parts?.[0]?.text) { botResponseText = data.candidates[0].content.parts[0].text.trim(); } 
                        else if (data.promptFeedback?.blockReason) { botResponseText = `Anfrage blockiert: ${data.promptFeedback.blockReason}.`; addToast(botResponseText, "warning", 6000); }
                    }
                    setDisplayMessage(botResponseText);
                    if (appData.setLastAIInteraction) { appData.setLastAIInteraction(userMessageText, botResponseText); }

                } catch (error) { setDisplayMessage("Kommunikationsfehler mit der KI."); addToast("Kommunikationsfehler: " + error.message, "error");
                } finally { setIsLoading(false); setInputValue(''); }
            };
            
            const suggestionClicked = (suggestion) => { setInputValue(suggestion); inputRef.current?.focus(); }

            return (
                <div className="mb-4 p-3 bg-slate-200 dark:bg-slate-700 rounded-lg shadow">
                    <div className="flex items-start gap-3">
                        <div className="flex-shrink-0 text-blue-600 dark:text-blue-400 pt-0.5"> <Sparkles className="w-5 h-5" /> </div>
                        <div className="flex-grow text-sm text-slate-700 dark:text-slate-200 min-h-[36px]">
                           {isLoading ? <span className="loader loader-gray !w-4 !h-4 !mr-2"></span> : ''} {displayMessage}
                        </div>
                    </div>
                     {!isLoading && displayMessage.startsWith("Hallo!") && (
                        <div className="mt-1.5 text-xs text-slate-500 dark:text-slate-400 pl-8">
                            <span>Vorschläge: </span>
                            <button onClick={() => suggestionClicked("Wie erstelle ich einen Dünger?")} className="underline hover:text-blue-500 dark:hover:text-blue-400">Dünger erstellen?</button>,&nbsp;
                            <button onClick={() => suggestionClicked("Ist mein N-Wert ok?")} className="underline hover:text-blue-500 dark:hover:text-blue-400">N-Wert ok?</button>,&nbsp;
                            <button onClick={() => suggestionClicked("Was ist EC?")} className="underline hover:text-blue-500 dark:hover:text-blue-400">Was ist EC?</button>
                        </div>
                    )}
                    <form onSubmit={handleSendMessage} className="mt-2 flex items-center gap-2 pl-8">
                        <input ref={inputRef} type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder={!apiKey ? "API Key fehlt" : "Stell deine Frage an die KI..."}
                            className="flex-1 px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 text-sm"
                            disabled={isLoading || !apiKey} />
                        <button type="submit" className="px-3 py-1.5 bg-blue-600 dark:bg-blue-700 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 flex items-center justify-center gap-1 text-sm disabled:bg-slate-400 dark:disabled:bg-slate-500"
                            disabled={isLoading || !inputValue.trim() || !apiKey}> {isLoading ? <span className="loader !w-4 !h-4"></span> :  "Fragen"} </button>
                    </form>
                </div>
            );
        };

        const WaterProfile = ({ customWaterProfile, handleCustomWaterProfileChange, commonInputClasses, commonLabelClasses }) => (
          <div className="mt-3">
            <h3 className="text-xs font-semibold text-slate-700 dark:text-slate-200 mb-1 flex items-center gap-1"><Water className="w-4 h-4" />Eigenes Wasserprofil</h3>
            <div className="grid grid-cols-2 gap-2">
              <div><label className={commonLabelClasses}>Ca (mg/L)</label><input type="number" name="ca" value={customWaterProfile.ca} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>Mg (mg/L)</label><input type="number" name="mg" value={customWaterProfile.mg} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>S (mg/L)</label><input type="number" name="s" value={customWaterProfile.s} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>Na (mg/L)</label><input type="number" name="na" value={customWaterProfile.na} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>Cl (mg/L)</label><input type="number" name="cl" value={customWaterProfile.cl} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>NO₃ (mg/L)</label><input type="number" name="no3" value={customWaterProfile.no3} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>SO₄ (mg/L)</label><input type="number" name="so4" value={customWaterProfile.so4} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>PO₄ (mg/L)</label><input type="number" name="po4" value={customWaterProfile.po4} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.1"/></div>
              <div><label className={commonLabelClasses}>Basis-EC (mS/cm)</label><input type="number" name="baseEC" value={customWaterProfile.baseEC} onChange={handleCustomWaterProfileChange} className={commonInputClasses} min="0" step="0.01"/></div>
            </div>
          </div>
        );

        const FertilizerManager = ({
          selectedFertilizers,
          fertilizerDatabase,
          waterVolume,
          addFertilizer,
          removeFertilizer,
          updateFertilizerAmount,
          toggleFertilizer,
          commonInputClasses
        }) => (
          <div className="space-y-2 max-h-[400px] lg:max-h-[calc(100vh-350px)] overflow-y-auto p-0.5">
            {(selectedFertilizers || []).map(fert => {
              const fertData = fertilizerDatabase[fert.id];
              if (!fertData) return null;
              return (
                <div key={fert.id} className={`p-2 border rounded-md ${fert.active ? 'bg-white dark:bg-slate-800 border-blue-300 dark:border-blue-600' : 'bg-slate-100 dark:bg-slate-900/50 border-slate-300 dark:border-slate-700'}`}>
                  <div className="flex items-center justify-between mb-1.5">
                    <div className="flex items-center gap-1.5">
                      <input type="checkbox" id={`fertActive-${fert.id}`} checked={fert.active} onChange={() => toggleFertilizer(fert.id)} className="w-3.5 h-3.5 text-blue-600 dark:text-blue-500 border-slate-300 dark:border-slate-600 rounded focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-slate-700"/>
                      <div>
                        <label htmlFor={`fertActive-${fert.id}`} className="text-xs font-medium text-slate-700 dark:text-slate-200 cursor-pointer">{fertData.name} {fertData.isCustom && <span className="text-xs text-sky-500 dark:text-sky-400" title="Custom Dünger">(C)</span>}</label>
                      </div>
                    </div>
                    <button onClick={() => removeFertilizer(fert.id)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-0.5" title="Entfernen"><Minus className="w-3 h-3" /></button>
                  </div>
                  <div className="flex items-center gap-1.5">
                    <input type="number" value={fert.amount} onChange={(e) => updateFertilizerAmount(fert.id, e.target.value)} disabled={!fert.active} className={`${commonInputClasses} flex-1 text-xs disabled:opacity-60`} min="0" step={fertData.type === 'powder' ? "0.01" : "0.1"}/>
                    <span className="text-xs text-slate-500 dark:text-slate-400 min-w-fit">{fertData.unit}/{waterVolume > 0 ? waterVolume : 1}L</span>
                  </div>
                </div>
              );
            })}
            <div className="border-t border-slate-300 dark:border-slate-700 pt-2 mt-2">
              <select onChange={(e) => addFertilizer(e.target.value)} className={commonInputClasses} value="">
                <option value="">Dünger hinzufügen...</option>
                {Object.entries(fertilizerDatabase).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([key, fert]) => (
                  <option key={key} value={key} disabled={(selectedFertilizers || []).some(f => f.id === key)}>
                    {fert.name}{fert.isCustom ? ' (C)' : ''}
                  </option>
                ))}
              </select>
            </div>
          </div>
        );

        const AdvancedNutrientCalculator = () => {
          const addToast = useToasts();
          const { theme, toggleTheme } = useTheme();
          const [lastUserQueryForAI, setLastUserQueryForAI] = useState(null);
          const [lastAIResponseForAI, setLastAIResponseForAI] = useState(null);
          const setLastAIInteraction = (userQuery, aiResponse) => { setLastUserQueryForAI(userQuery); setLastAIResponseForAI(aiResponse); };

          const initialGrowthStage = 'veg2';
          const [waterVolume, setWaterVolume] = useState(10); const [growthStage, setGrowthStage] = useState(initialGrowthStage); const [waterType, setWaterType] = useState('ro'); const [customWaterProfile, setCustomWaterProfile] = useState(initialCustomWaterProfile);
          const [results, setResults] = useState({ nutrients: {}, contributions: {}, stage: GROWTH_STAGES[initialGrowthStage] }); const [activeTab, setActiveTab] = useState(TAB_BASIC);
          const [customFertilizers, setCustomFertilizers] = useState([]);
          const [fertilizerFormState, setFertilizerFormState] = useState({ name: '', type: 'liquid', unit: 'ml', description: '', isCustom: true, composition: Object.fromEntries(NUTRIENT_FIELDS.map(field => [field.key, 0])), });
          const [editingFertilizerId, setEditingFertilizerId] = useState(null);
          const [selectedFertilizers, setSelectedFertilizers] = useState([ { id: 'ta_calmg', amount: 1.0, active: true }, { id: 'hesi_tnt', amount: 3.0, active: true }, ]);
          const importFileRef = useRef(null);

          useEffect(() => { try { const stored = localStorage.getItem(LOCAL_STORAGE_KEY_CUSTOM_FERTILIZERS); if (stored) { const parsed = JSON.parse(stored); if (Array.isArray(parsed)) { const validFertilizers = parsed.map(f => ({ name: f.name || 'Unbenannt', type: f.type === 'powder' ? 'powder' : 'liquid', unit: f.type === 'powder' ? 'g' : 'ml', description: f.description || '', isCustom: true, id: f.id || generateNewId(), composition: NUTRIENT_FIELDS.reduce((acc, field) => { acc[field.key] = Number(f.composition?.[field.key]) || 0; return acc; }, {}), })).filter(f => f.id && typeof f.name === 'string'); setCustomFertilizers(validFertilizers); } } } catch (e) { console.error("Ladefehler Custom Dünger:", e); addToast("Fehler eigene Dünger.", "error");} }, [addToast]);
          useEffect(() => { localStorage.setItem(LOCAL_STORAGE_KEY_CUSTOM_FERTILIZERS, JSON.stringify(customFertilizers)); }, [customFertilizers]);
          useEffect(() => { try { const storedProfile = localStorage.getItem(LOCAL_STORAGE_KEY_CUSTOM_WATER); if (storedProfile) { const parsed = JSON.parse(storedProfile); setCustomWaterProfile({ ca: Number(parsed.ca) || 0, mg: Number(parsed.mg) || 0, s: Number(parsed.s) || 0, na: Number(parsed.na) || 0, cl: Number(parsed.cl) || 0, no3: Number(parsed.no3) || 0, so4: Number(parsed.so4) || 0, po4: Number(parsed.po4) || 0, baseEC: Number(parsed.baseEC) || 0.0, }); } } catch (e) { console.error("Ladefehler Wasserprofil:", e); setCustomWaterProfile(initialCustomWaterProfile); addToast("Fehler Wasserprofil.", "error");} }, [addToast]);
          useEffect(() => { localStorage.setItem(LOCAL_STORAGE_KEY_CUSTOM_WATER, JSON.stringify(customWaterProfile)); }, [customWaterProfile]);

          const fertilizerDatabase = useMemo(() => { const combined = { ...BASE_FERTILIZER_DATABASE }; customFertilizers.forEach(fert => { combined[fert.id] = fert; }); return combined; }, [customFertilizers]);
          const handleCustomWaterProfileChange = (e) => { const { name, value } = e.target; setCustomWaterProfile(prev => ({ ...prev, [name]: Math.max(0, parseFloat(value)) || 0 })); };
          const calculateResults = useCallback(() => {
            setResults(calculateNutrientResults({
              waterVolume,
              growthStage,
              waterType,
              selectedFertilizers,
              fertilizerDatabase,
              customWaterProfile,
              NUTRIENT_FIELDS,
              GROWTH_STAGES,
              WATER_TYPES
            }));
          }, [waterVolume,growthStage,waterType,selectedFertilizers,fertilizerDatabase,customWaterProfile]);
          useEffect(() => { calculateResults(); }, [calculateResults]);

          const addFertilizer = (id) => { if (!id || (selectedFertilizers||[]).find(f=>f.id===id)) return; const d = fertilizerDatabase[id]; setSelectedFertilizers(p=>[...(p||[]),{id,amount:d?.type==='powder'?0.1:1.0,active:true}]);};
          const removeFertilizer = (id) => { setSelectedFertilizers(p=>(p||[]).filter(f=>f.id!==id));};
          const updateFertilizerAmount = (id,val) => { const a=parseFloat(val); setSelectedFertilizers(p=>(p||[]).map(f=>f.id===id?{...f,amount:isNaN(a)||a<0?0:a}:f));};
          const toggleFertilizer = (id) => { setSelectedFertilizers(p=>(p||[]).map(f=>f.id===id?{...f,active:!f.active}:f));};
          const handleCustomFertilizerInputChange = (e) => { const {name,value}=e.target; setFertilizerFormState(p=>({...p,[name]:value}));};
          const handleCustomFertilizerCompositionChange = (e) => { const {name,value}=e.target; const pV=parseFloat(value); setFertilizerFormState(p=>({...p,composition:{...p.composition,[name]:isNaN(pV)||pV<0?0:pV}}));};
          const resetCustomFertilizerForm = () => { setEditingFertilizerId(null); setFertilizerFormState({name:'',type:'liquid',unit:'ml',description:'',isCustom:true,composition:Object.fromEntries(NUTRIENT_FIELDS.map(f=>[f.key,0]))});};
          const handleAddNewCustomFertilizerLogic = () => { const tN=fertilizerFormState.name.trim(); if(!tN){addToast("Name?","warning");return;} if(customFertilizers.some(f=>f.name.toLowerCase()===tN.toLowerCase())||Object.values(BASE_FERTILIZER_DATABASE).some(f=>f.name.toLowerCase()===tN.toLowerCase())){addToast("Name existiert","error");return;} const nId=generateNewId(); const fTA={...fertilizerFormState,id:nId,name:tN,unit:fertilizerFormState.type==='liquid'?'ml':'g',isCustom:true}; setCustomFertilizers(p=>[...p,fTA]); addToast(`"${tN}" hinzugefügt`,'success'); resetCustomFertilizerForm();};
          const handleUpdateExistingCustomFertilizer = () => { const tN=fertilizerFormState.name.trim(); if(!tN){addToast("Name?","warning");return;} const nC=customFertilizers.some(f=>f.name.toLowerCase()===tN.toLowerCase()&&f.id!==editingFertilizerId)||Object.values(BASE_FERTILIZER_DATABASE).some(f=>f.name.toLowerCase()===tN.toLowerCase()); if(nC){addToast("Name existiert","error");return;} const uF={...fertilizerFormState,id:editingFertilizerId,name:tN,unit:fertilizerFormState.type==='liquid'?'ml':'g',isCustom:true}; setCustomFertilizers(pCFs=>pCFs.map(f=>f.id===editingFertilizerId?uF:f)); addToast(`"${tN}" aktualisiert`,'success'); resetCustomFertilizerForm();};
          const handleCustomFertilizerFormSubmit = (e) => {e.preventDefault();if(editingFertilizerId){handleUpdateExistingCustomFertilizer();}else{handleAddNewCustomFertilizerLogic();}};
          const handleStartEditCustomFertilizer = (id) => { const fTE=customFertilizers.find(f=>f.id===id); if(fTE){setEditingFertilizerId(id); setFertilizerFormState({name:fTE.name||'',type:fTE.type||'liquid',unit:fTE.unit||(fTE.type==='powder'?'g':'ml'),description:fTE.description||'',isCustom:true,id:fTE.id,composition:NUTRIENT_FIELDS.reduce((acc,field)=>{acc[field.key]=Number(fTE.composition?.[field.key])||0;return acc;},{}),}); document.getElementById('customFertName')?.focus();}};
          const handleDeleteCustomFertilizer = (id) => { if(window.confirm("Eigenen Dünger löschen?")){ const fTD=customFertilizers.find(f=>f.id===id); setCustomFertilizers(p=>p.filter(f=>f.id!==id)); setSelectedFertilizers(pS=>(pS||[]).filter(sf=>sf.id!==id)); if(editingFertilizerId===id){resetCustomFertilizerForm();} if(fTD)addToast(`"${fTD.name}" gelöscht`,'info');}};
          const getNutrientStatus = (v,r) => {if(!r||!Array.isArray(r)||r.length!==2)return 'neutral';const [min,max]=r;if(v<min*0.8)return 'low';if(v>max*1.2)return 'high';if(v>=min&&v<=max)return 'optimal';return 'moderate';};
          const getStatusColor = (s) => { switch(s){ case 'low':return 'text-blue-700 bg-blue-100 dark:text-blue-300 dark:bg-blue-700/30 border border-blue-200 dark:border-blue-600'; case 'high':return 'text-red-700 bg-red-100 dark:text-red-300 dark:bg-red-700/30 border border-red-200 dark:border-red-600'; case 'optimal':return 'text-green-700 bg-green-100 dark:text-green-300 dark:bg-green-700/30 border border-green-200 dark:border-green-600'; case 'moderate':return 'text-yellow-700 bg-yellow-100 dark:text-yellow-300 dark:bg-yellow-600/30 border border-yellow-200 dark:border-yellow-500'; default:return 'text-slate-600 bg-slate-100 dark:text-slate-400 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600'; }};
          const getStatusIcon = (s) => {switch(s){case 'optimal':return <CheckCircle className="w-4 h-4"/>;default:return <AlertCircle className="w-4 h-4"/>;}};
          const optimizeNutrients = () => { const c=growthStage; if(c.includes('veg')){if(fertilizerDatabase['hesi_tnt'])updateFertilizerAmount('hesi_tnt','5.0');if(fertilizerDatabase['ta_calmg'])updateFertilizerAmount('ta_calmg','2.5');}else if(c.includes('flower')){if(fertilizerDatabase['hesi_bloom'])updateFertilizerAmount('hesi_bloom','6.0');} addToast("Basisrezept geladen.","info");};
          const getRecommendedFertilizers = () => {if(growthStage.includes('veg'))return['hesi_tnt','ta_calmg'];if(growthStage.includes('flower'))return['hesi_bloom'];return['hesi_tnt','ta_calmg'];};
          const getProgressBarWidth = (v,r) => {if(!r||!Array.isArray(r)||r.length!==2||r[1]===0)return 0;const mT=r[1]*1.2;return Math.min((v/mT)*100,100);};
          const exportRecipe = () => { const rec={v:RECIPE_VERSION,name:`${GROWTH_STAGES[growthStage]?.name||'Unbekannt'} - ${new Date().toLocaleDateString()}`,wv:waterVolume,gs:growthStage,wt:waterType,cwpd:waterType==='custom'?customWaterProfile:null,sf:(selectedFertilizers||[]).map(s=>({i:s.id,a:s.amount,ac:s.active})),dcf:customFertilizers,ts:new Date().toISOString()}; const blob=new Blob([JSON.stringify(rec,null,1)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');a.href=url;a.download=`nutrient-recipe-${growthStage}-${Date.now()}.json`;a.click();URL.revokeObjectURL(url);addToast("Rezept exportiert!","success");};
          const handleImportRecipe = (event) => { const file=event.target.files[0];if(!file)return; const reader=new FileReader();reader.onload=(e)=>{let ok=true;try{const iR=JSON.parse(e.target.result);if(!iR||iR.v!==RECIPE_VERSION){addToast(`Falsche Rezeptversion.`,'error');ok=false;return;}if(!iR.sf||!Array.isArray(iR.sf)||!iR.dcf||!Array.isArray(iR.dcf)){addToast("Rezept unvollständig.",'error');ok=false;return;}let cCFs=[...customFertilizers];const rCFs=iR.dcf||[];const bFNL=Object.values(BASE_FERTILIZER_DATABASE).map(f=>f.name.toLowerCase());rCFs.forEach(rcf=>{if(!rcf||!rcf.id||!rcf.name)return;if(cCFs.find(c=>c.id===rcf.id))return;const nl=rcf.name.toLowerCase();if(cCFs.some(c=>c.name.toLowerCase()===nl)||bFNL.includes(nl)){addToast(`CustomDünger "${rcf.name}" übersprungen: Namenskonflikt.`,'warning');}else{const normRcf={name:rcf.name,type:rcf.type==='powder'?'powder':'liquid',unit:rcf.type==='powder'?'g':'ml',description:rcf.description||'',isCustom:true,id:rcf.id,composition:NUTRIENT_FIELDS.reduce((acc,field)=>{acc[field.key]=Number(rcf.composition?.[field.key])||0;return acc;},{}),};cCFs.push(normRcf);}});setCustomFertilizers(cCFs);const tFDb={...BASE_FERTILIZER_DATABASE};cCFs.forEach(f=>{tFDb[f.id]=f;});setWaterVolume(Number(iR.wv)||10);setGrowthStage(GROWTH_STAGES[iR.gs]?iR.gs:initialGrowthStage);const nWT=WATER_TYPES[iR.wt]?iR.wt:'ro';setWaterType(nWT);if(nWT==='custom'&&iR.cwpd){setCustomWaterProfile({ca:Number(iR.cwpd.ca)||0,mg:Number(iR.cwpd.mg)||0,s:Number(iR.cwpd.s)||0,baseEC:Number(iR.cwpd.baseEC)||0,});}else if(nWT==='custom'){setCustomWaterProfile(initialCustomWaterProfile);}const vSFs=(iR.sf||[]).filter(s=>s&&s.i&&tFDb[s.i]).map(s=>({id:s.i,amount:Math.max(0,Number(s.a))||0,active:typeof s.ac==='boolean'?s.ac:true,}));setSelectedFertilizers(vSFs);if(ok)addToast("Rezept geladen!",'success');}catch(err){console.error("Import Fehler:",err);addToast("Import Fehler: "+err.message,'error');}finally{if(importFileRef.current)importFileRef.current.value="";}};reader.readAsText(file);};
          
          const TABS_CONFIG = [
            { id: TAB_BASIC, label: 'Setup' },
            { id: TAB_ADVANCED, label: 'Details' },
            { id: TAB_ANALYSIS, label: 'Analyse' },
            { id: TAB_CUSTOM_FERTILIZER, label: 'Dünger' },
            { id: TAB_SETTINGS, label: 'Einstellungen' }
          ];
          const appDataForChatbar = { waterVolume, growthStage, waterType, customWaterProfile, selectedFertilizers, fertilizerDatabase, results, GROWTH_STAGES_DATA: GROWTH_STAGES, WATER_TYPES_DATA: WATER_TYPES, NUTRIENT_FIELDS_DATA: NUTRIENT_FIELDS, lastUserQueryForAI, lastAIResponseForAI, setLastAIInteraction };

          const commonInputClasses = "w-full px-2 py-1 text-sm border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400";
          const commonLabelClasses = "block text-xs font-medium text-slate-600 dark:text-slate-300 mb-0.5";
          const commonContainerClasses = "space-y-3 bg-slate-100 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700";
          const commonTitleClasses = "text-md font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2";
          const commonButtonClasses = "w-full px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 flex items-center justify-center gap-1.5";

          const clearAllData = () => {
            if (window.confirm('Alle Daten (eigene Dünger, Wasserprofil, Auswahl) wirklich löschen?')) {
              localStorage.removeItem(LOCAL_STORAGE_KEY_CUSTOM_FERTILIZERS);
              localStorage.removeItem(LOCAL_STORAGE_KEY_CUSTOM_WATER);
              setCustomFertilizers([]);
              setCustomWaterProfile(initialCustomWaterProfile);
              setSelectedFertilizers([ { id: 'ta_calmg', amount: 1.0, active: true }, { id: 'hesi_tnt', amount: 3.0, active: true } ]);
              addToast('Alle Daten wurden zurückgesetzt.', 'info');
            }
          };

          return (
            <div className="max-w-4xl mx-auto p-3 sm:p-4 bg-white dark:bg-slate-800 rounded-lg shadow-xl transition-colors duration-300">
              <div className="flex flex-col sm:flex-row items-center justify-between mb-3 gap-3"> 
                <div className="flex items-center gap-2"> 
                    <Calculator className="w-7 h-7 text-blue-600 dark:text-blue-400" /> 
                    <div> <h1 className="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100">Düngerrechner Pro</h1> <p className="text-xs text-slate-600 dark:text-slate-400">Nährstoffberechnung mit KI Helfer</p> </div> 
                </div> 
                <div className="flex items-center gap-2"> 
                    <button onClick={toggleTheme} className="p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300" title="Toggle Dark Mode"> {theme === 'light' ? <Moon className="w-5 h-5"/> : <Sun className="w-5 h-5"/>} </button>
                    <input type="file" ref={importFileRef} onChange={handleImportRecipe} accept=".json" style={{ display: 'none' }} id="import-recipe-input" /> 
                    <button onClick={() => importFileRef.current?.click()} className="px-3 py-1.5 bg-sky-600 text-white rounded-md hover:bg-sky-700 dark:bg-sky-700 dark:hover:bg-sky-600 flex items-center gap-1.5 transition-colors text-sm"> <Upload className="w-4 h-4" /> Import </button> 
                    <button onClick={exportRecipe} className="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 flex items-center gap-1.5 transition-colors text-sm"> <Download className="w-4 h-4" /> Export </button> 
                </div> 
              </div>
              <ChatBar appData={appDataForChatbar} />
              <div className="flex mb-4 border-b border-slate-300 dark:border-slate-700 flex-wrap"> {TABS_CONFIG.map(tabInfo => ( <button key={tabInfo.id} className={`px-3 sm:px-4 py-2.5 font-medium transition-colors text-xs sm:text-sm ${activeTab === tabInfo.id ? 'border-b-2 border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200'}`} onClick={() => setActiveTab(tabInfo.id)}> {tabInfo.label} </button> ))} </div>
              
              {activeTab === TAB_BASIC && (
                <div className="grid lg:grid-cols-3 gap-4">
                  <div className="space-y-3"> 
                    <h2 className={commonTitleClasses}><Settings className="w-4 h-4" />Grundkonfiguration</h2>
                    <div className={commonContainerClasses}>
                      <div> <label htmlFor="waterVolumeInput" className={commonLabelClasses}>Wassermenge (L)</label> <input id="waterVolumeInput" type="number" value={waterVolume} onChange={(e) => setWaterVolume(Math.max(0.1, Number(e.target.value)))} className={commonInputClasses} min="0.1" step="0.1"/> </div>
                      <div> <label htmlFor="growthStageSelect" className={commonLabelClasses}>Wachstumsphase</label> <select id="growthStageSelect" value={growthStage} onChange={(e) => setGrowthStage(e.target.value)} className={commonInputClasses}> {Object.entries(GROWTH_STAGES).map(([key, stage]) => (<option key={key} value={key}>{stage.name}</option>))} </select> </div>
                      <div> <label htmlFor="waterTypeSelect" className={commonLabelClasses}>Wassertyp</label> <select id="waterTypeSelect" value={waterType} onChange={(e) => setWaterType(e.target.value)} className={commonInputClasses}> {Object.entries(WATER_TYPES).map(([key, water]) => (<option key={key} value={key}>{water.name}</option>))} </select> </div>
                      {waterType === 'custom' && (
                        <WaterProfile
                          customWaterProfile={customWaterProfile}
                          handleCustomWaterProfileChange={handleCustomWaterProfileChange}
                          commonInputClasses={commonInputClasses}
                          commonLabelClasses={commonLabelClasses}
                        />
                      )}
                      <button onClick={optimizeNutrients} className={commonButtonClasses}> <Target className="w-4 h-4" />Auto-Opt. </button>
                      <button onClick={clearAllData} className="w-full px-3 py-1.5 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 flex items-center justify-center gap-1.5 mt-2"> <Trash2 className="w-4 h-4" />Alle Daten zurücksetzen</button>
                    </div>
                  </div>
                  <div className="space-y-3"> 
                    <h2 className={commonTitleClasses}><Beaker className="w-4 h-4" />Dünger & Dosierung</h2>
                    <div className="space-y-2 max-h-[400px] lg:max-h-[calc(100vh-350px)] overflow-y-auto p-0.5">
                      {(selectedFertilizers || []).map(fert => { const fertData = fertilizerDatabase[fert.id]; if (!fertData) return null;
                        return ( <div key={fert.id} className={`p-2 border rounded-md ${fert.active ? 'bg-white dark:bg-slate-800 border-blue-300 dark:border-blue-600' : 'bg-slate-100 dark:bg-slate-900/50 border-slate-300 dark:border-slate-700'}`}> <div className="flex items-center justify-between mb-1.5"> <div className="flex items-center gap-1.5"> <input type="checkbox" id={`fertActive-${fert.id}`} checked={fert.active} onChange={() => toggleFertilizer(fert.id)} className="w-3.5 h-3.5 text-blue-600 dark:text-blue-500 border-slate-300 dark:border-slate-600 rounded focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-slate-700"/> <div> <label htmlFor={`fertActive-${fert.id}`} className="text-xs font-medium text-slate-700 dark:text-slate-200 cursor-pointer"> {fertData.name} {fertData.isCustom && <span className="text-xs text-sky-500 dark:text-sky-400" title="Custom Dünger">(C)</span>} </label> </div> </div> <button onClick={() => removeFertilizer(fert.id)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-0.5" title="Entfernen"><Minus className="w-3 h-3" /></button> </div> <div className="flex items-center gap-1.5"> <input type="number" value={fert.amount} onChange={(e) => updateFertilizerAmount(fert.id, e.target.value)} disabled={!fert.active} className={`${commonInputClasses} flex-1 text-xs disabled:opacity-60`} min="0" step={fertData.type === 'powder' ? "0.01" : "0.1"}/> <span className="text-xs text-slate-500 dark:text-slate-400 min-w-fit">{fertData.unit}/{waterVolume > 0 ? waterVolume : 1}L</span> </div> </div> ); })}
                      <div className="border-t border-slate-300 dark:border-slate-700 pt-2 mt-2"> <select onChange={(e) => addFertilizer(e.target.value)} className={commonInputClasses} value=""> <option value="">Dünger hinzufügen...</option> {Object.entries(fertilizerDatabase).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([key, fert]) => ( <option key={key} value={key} disabled={(selectedFertilizers || []).some(f => f.id === key)}> {fert.name}{fert.isCustom ? ' (C)' : ''} </option> ))} </select> </div>
                    </div>
                  </div>
                  <div className="space-y-3"> 
                    <h2 className={commonTitleClasses}><Droplets className="w-4 h-4" />Nährstoffprofil (ppm)</h2>
                    <div className={`${commonContainerClasses} space-y-3`}> <div className="flex justify-between items-center text-xs text-slate-600 dark:text-slate-300"> <span>Ziel: {results.stage?.name}</span><Zap className="w-3 h-3 text-yellow-500 dark:text-yellow-400" /> </div> <div className="space-y-1.5"> {[ { key: 'n', label: 'N', unit: 'ppm', range: results.stage?.n }, { key: 'p', label: 'P', unit: 'ppm', range: results.stage?.p }, { key: 'k', label: 'K', unit: 'ppm', range: results.stage?.k }, { key: 'ca', label: 'Ca', unit: 'ppm', range: [80, 120] }, { key: 'mg', label: 'Mg', unit: 'ppm', range: [30, 60] }, { key: 'ec', label: 'EC', unit: 'mS/cm', range: results.stage?.ec } ].map(nutrient => { const value = results.nutrients?.[nutrient.key] ?? 0; const status = getNutrientStatus(value, nutrient.range); return ( <div key={nutrient.key} className={`flex justify-between items-center p-1.5 rounded-md text-xs ${getStatusColor(status)}`}> <span className="flex items-center gap-1">{getStatusIcon(status)}{nutrient.label}:</span> <div className="text-right"> <span className="font-medium">{value.toFixed(nutrient.key === 'ec' ? 2:1)} {nutrient.unit}</span> {nutrient.range && (<div className="text-[0.65rem] opacity-70">({nutrient.range[0]}-{nutrient.range[1]})</div>)} </div> </div> ); })} </div> </div>
                    {Array.isArray(selectedFertilizers) && selectedFertilizers.filter(f => f.active && Number(f.amount) > 0).length > 0 && ( <div className="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-lg border border-blue-300 dark:border-blue-700 text-xs"> <h3 className="font-medium text-blue-800 dark:text-blue-200 mb-1.5 flex items-center gap-1"><Info className="w-3 h-3" />Dosierung</h3> <div className="space-y-1 text-blue-700 dark:text-blue-300"> {(selectedFertilizers || []).filter(f => f.active && Number(f.amount) > 0).map((fert, index) => { const fertData = fertilizerDatabase[fert.id]; return fertData ? ( <div key={fert.id} className="flex justify-between"> <span>{index + 1}. {fertData.name}</span> <span className="font-medium">{Number(fert.amount).toFixed(fertData.type === 'powder' ? 2:1)} {fertData.unit}</span> </div> ) : null; })} <div className="mt-2 pt-1.5 border-t border-blue-300 dark:border-blue-600 text-[0.65rem] text-blue-600 dark:text-blue-400"> Einzeln zugeben, mischen. pH prüfen. </div> </div> </div> )}
                  </div>
                </div>
              )}
              {activeTab === TAB_ADVANCED && (
                 <div className="grid lg:grid-cols-2 gap-4">
                  <div className="space-y-3">
                    <h2 className={commonTitleClasses}>Mikronährstoffe (ppm)</h2>
                    <div className={`${commonContainerClasses} space-y-1.5`}>
                      {[ { key: 'fe', label: 'Eisen (Fe)', optimal: [0.5, 2.5] }, { key: 'mn', label: 'Mangan (Mn)', optimal: [0.2, 1.0] }, { key: 'zn', label: 'Zink (Zn)', optimal: [0.05, 0.2] }, { key: 'cu', label: 'Kupfer (Cu)', optimal: [0.01, 0.05] }, { key: 'b', label: 'Bor (B)', optimal: [0.02, 0.1] }, { key: 'mo', label: 'Molybdän (Mo)', optimal: [0.005, 0.02] }
                      ].map(micro => { const value = results.nutrients?.[micro.key] ?? 0; const status = getNutrientStatus(value, micro.optimal);
                        return ( <div key={micro.key} className={`flex justify-between items-center p-1.5 rounded-md text-xs ${getStatusColor(status)}`}> <span className="flex items-center gap-1">{getStatusIcon(status)}{micro.label}:</span> <div className="text-right"> <span className="font-medium">{value.toFixed(3)} ppm</span> <div className="text-[0.65rem] opacity-70">({micro.optimal[0]}-{micro.optimal[1]})</div> </div> </div> );
                      })}
                    </div>
                  </div>
                  <div className="space-y-3">
                    <h2 className={commonTitleClasses}>Weitere Makro-/Sekundärnährstoffe (ppm)</h2>
                    <div className={`${commonContainerClasses} space-y-1.5`}>
                      {[ { key: 's', label: 'Schwefel (S)', optimal: [30, 70] }
                      ].map(secondary => { const value = results.nutrients?.[secondary.key] ?? 0; const status = getNutrientStatus(value, secondary.optimal);
                        return ( <div key={secondary.key} className={`flex justify-between items-center p-1.5 rounded-md text-xs ${getStatusColor(status)}`}> <span className="flex items-center gap-1">{getStatusIcon(status)}{secondary.label}:</span> <div className="text-right"> <span className="font-medium">{value.toFixed(1)} ppm</span> <div className="text-[0.65rem] opacity-70">({secondary.optimal[0]}-{secondary.optimal[1]})</div> </div> </div> );
                      })}
                    </div>
                    <div className="bg-yellow-100 dark:bg-yellow-700/30 p-3 rounded-lg border border-yellow-300 dark:border-yellow-600"> <h3 className="font-medium text-yellow-800 dark:text-yellow-200 mb-1.5 text-sm flex items-center gap-1"><AlertCircle className="w-4 h-4" />Nährstoff-Hinweise</h3> <ul className="text-xs text-yellow-700 dark:text-yellow-300 space-y-1 list-disc list-inside"> <li>Weniger ist oft mehr, besonders bei Mikronährstoffen.</li> <li>Bei Mangelerscheinungen zuerst pH-Wert und Wurzelgesundheit prüfen.</li> <li>Fe-Mangel: junge Blätter hellgrün/gelb, Adern bleiben grün.</li> <li>Ca-Mangel: junge Blätter verformt, Blütenendfäule.</li> </ul> </div>
                  </div>
                </div>
              )}
              {activeTab === TAB_ANALYSIS && (
                <div className="space-y-4">
                  <h2 className={commonTitleClasses}><BarChart3 className="w-4 h-4" />Analyse & Empfehlung</h2>
                  <div className={`${commonContainerClasses} p-3 sm:p-4`}>
                    <h3 className="font-semibold text-slate-800 dark:text-slate-100 mb-3 text-sm">Nährstoff-Beiträge nach Nährstoff (ppm)</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-xs">
                        <thead className="text-slate-700 dark:text-slate-300">
                          <tr className="border-b border-slate-300 dark:border-slate-600">
                            <th className="text-left p-1.5 font-medium">Dünger</th>
                            {NUTRIENT_FIELDS.map(n => (
                              <th key={n.key} className="text-center p-1.5 font-medium">{n.label.split(' ')[0]}</th>
                            ))}
                          </tr>
                        </thead>
                        <tbody className="text-slate-600 dark:text-slate-300">
                          {(selectedFertilizers || []).filter(f => f.active && Number(f.amount) > 0).map(fert => {
                            const fertData = fertilizerDatabase[fert.id];
                            const contribution = results.contributions?.[fert.id] || {};
                            if (!fertData) return null;
                            return (
                              <tr key={fert.id} className="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <td className="p-1.5 font-medium text-slate-700 dark:text-slate-200">{fertData.name} {fertData.isCustom && <span className="text-xs text-sky-500 dark:text-sky-400" title="Custom Dünger">(C)</span>}</td>
                                {NUTRIENT_FIELDS.map(nField => (
                                  <td key={nField.key} className="text-center p-1.5">{(Number(contribution[nField.key]) || 0).toFixed(2)}</td>
                                ))}
                              </tr>
                            );
                          })}
                          <tr className="border-t-2 border-slate-300 dark:border-slate-600 font-semibold bg-slate-100 dark:bg-slate-700/50 text-slate-700 dark:text-slate-200">
                            <td className="p-1.5">Gesamt</td>
                            {NUTRIENT_FIELDS.map(nField => {
                              const value = results.nutrients?.[nField.key] || 0;
                              // Determine optimal range for each nutrient
                              let optimal = null;
                              if (["n","p","k"].includes(nField.key)) optimal = results.stage?.[nField.key];
                              else if (nField.key === "ca") optimal = [80, 120];
                              else if (nField.key === "mg") optimal = [30, 60];
                              else if (nField.key === "s") optimal = [30, 70];
                              else if (nField.key === "fe") optimal = [0.5, 2.5];
                              else if (nField.key === "mn") optimal = [0.2, 1.0];
                              else if (nField.key === "zn") optimal = [0.05, 0.2];
                              else if (nField.key === "cu") optimal = [0.01, 0.05];
                              else if (nField.key === "b") optimal = [0.02, 0.1];
                              else if (nField.key === "mo") optimal = [0.005, 0.02];
                              const status = getNutrientStatus(value, optimal);
                              return (
                                <td key={nField.key} className={`text-center p-1.5 ${getStatusColor(status)}`} title={status !== 'optimal' ? 'Außerhalb Zielbereich' : 'Im Zielbereich'}>
                                  {value.toFixed(2)}
                                  {status !== 'optimal' && <span className="ml-1 align-middle">{getStatusIcon(status)}</span>}
                                </td>
                              );
                            })}
                          </tr>
                          <tr className="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400">
                            <td className="p-1.5 font-medium">Optimal</td>
                            {NUTRIENT_FIELDS.map(nField => {
                              let optimal = null;
                              if (["n","p","k"].includes(nField.key)) optimal = results.stage?.[nField.key];
                              else if (nField.key === "ca") optimal = [80, 120];
                              else if (nField.key === "mg") optimal = [30, 60];
                              else if (nField.key === "s") optimal = [30, 70];
                              else if (nField.key === "fe") optimal = [0.5, 2.5];
                              else if (nField.key === "mn") optimal = [0.2, 1.0];
                              else if (nField.key === "zn") optimal = [0.05, 0.2];
                              else if (nField.key === "cu") optimal = [0.01, 0.05];
                              else if (nField.key === "b") optimal = [0.02, 0.1];
                              else if (nField.key === "mo") optimal = [0.005, 0.02];
                              return (
                                <td key={nField.key} className="text-center p-1.5">
                                  {optimal ? `${optimal[0]}-${optimal[1]}` : '-'}
                                </td>
                              );
                            })}
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="bg-green-100 dark:bg-green-800/30 border border-green-300 dark:border-green-700 rounded-lg p-3"> <h3 className="font-semibold text-green-800 dark:text-green-200 mb-1.5 text-sm flex items-center gap-1"><CheckCircle className="w-4 h-4" />Optimierung</h3> <ul className="space-y-1 text-xs text-green-700 dark:text-green-300 list-disc list-inside"> {(() => { const recs = []; const R = results.nutrients; const S = results.stage; if (S && R && S.n && S.p && S.k) { if (R.n < S.n[0]) recs.push("N erhöhen."); else if (R.n > S.n[1]*1.2) recs.push("N reduzieren."); if (R.p < S.p[0]) recs.push("P erhöhen."); else if (R.p > S.p[1]*1.2) recs.push("P reduzieren."); if (R.k < S.k[0]) recs.push("K erhöhen."); else if (R.k > S.k[1]*1.2) recs.push("K reduzieren."); } if (recs.length === 0 && S) recs.push("NPK-Werte im Zielbereich!"); else if (!S) recs.push("Keine Zielwerte."); recs.push("pH-Wert kontrollieren."); recs.push("EC-Wert beobachten."); return recs.map((rec, i) => <li key={i}>{rec}</li>); })()} </ul> </div>
                    <div className="bg-red-100 dark:bg-red-800/30 border border-red-300 dark:border-red-700 rounded-lg p-3"> <h3 className="font-semibold text-red-800 dark:text-red-200 mb-1.5 text-sm flex items-center gap-1"><AlertCircle className="w-4 h-4" />Hinweise</h3> <ul className="space-y-1 text-xs text-red-700 dark:text-red-300 list-disc list-inside"> <li>EC: <strong>{(results.nutrients?.ec || 0).toFixed(2)} mS/cm</strong>.</li> <li>Dünger einzeln mischen.</li> <li>Konzentrate nicht mischen.</li> <li>Bei Überdüngung spülen.</li> </ul> </div>
                  </div>
                  <div className={`${commonContainerClasses} p-3 sm:p-4`}>
                    <h3 className="font-semibold text-slate-800 dark:text-slate-100 mb-3 text-sm flex items-center gap-1"><TrendingUp className="w-4 h-4" />Nährstoffbedarf Phasen</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-[0.7rem]">
                        <thead className="text-slate-600 dark:text-slate-400"><tr className="border-b border-slate-300 dark:border-slate-600"><th className="text-left p-1">Phase</th><th className="text-center p-1">N</th><th className="text-center p-1">P</th><th className="text-center p-1">K</th><th className="text-center p-1">EC</th></tr></thead>
                        <tbody className="text-slate-600 dark:text-slate-300"> {Object.entries(GROWTH_STAGES).map(([key, stage]) => ( <tr key={key} className={`border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 ${key === growthStage ? 'bg-blue-100 dark:bg-blue-700/50 font-semibold text-blue-800 dark:text-blue-300' : ''}`}> <td className="p-1">{stage.name}</td><td className="text-center p-1">{stage.n[0]}-{stage.n[1]}</td><td className="text-center p-1">{stage.p[0]}-{stage.p[1]}</td> <td className="text-center p-1">{stage.k[0]}-{stage.k[1]}</td><td className="text-center p-1">{stage.ec[0]}-{stage.ec[1]}</td> </tr> ))} </tbody>
                      </table>
                    </div> <p className="text-[0.65rem] text-slate-500 dark:text-slate-400 mt-1">* Blau: Aktuell ausgewählte Phase.</p>
                  </div>
                  <div className="mt-6">
                    <ReferencesSection />
                  </div>
                </div>
              )}
              {activeTab === TAB_CUSTOM_FERTILIZER && (
                <div className="grid lg:grid-cols-2 gap-4">
                  <div className="space-y-3">
                    <h2 className={commonTitleClasses}> {editingFertilizerId ? <Edit className="w-4 h-4" /> : <ListPlus className="w-4 h-4" />} {editingFertilizerId ? 'Dünger bearbeiten' : 'Neuen Dünger hinzufügen'} </h2>
                    <form onSubmit={handleCustomFertilizerFormSubmit} className={`${commonContainerClasses} p-3 sm:p-4 space-y-3`}>
                      <div> <label htmlFor="customFertName" className={commonLabelClasses}>Name*</label> <input type="text" id="customFertName" name="name" value={fertilizerFormState.name} onChange={handleCustomFertilizerInputChange} required className={commonInputClasses}/> </div>
                      <div className="grid grid-cols-2 gap-3"> <div> <label htmlFor="customFertType" className={commonLabelClasses}>Typ*</label> <select name="type" id="customFertType" value={fertilizerFormState.type} onChange={handleCustomFertilizerInputChange} className={commonInputClasses}> <option value="liquid">Flüssig (ml)</option> <option value="powder">Pulver (g)</option> </select> </div> <div> <label htmlFor="customFertDesc" className={commonLabelClasses}>Beschreibung</label> <input type="text" id="customFertDesc" name="description" value={fertilizerFormState.description} onChange={handleCustomFertilizerInputChange} className={commonInputClasses}/> </div> </div>
                      <h3 className="text-sm font-semibold text-slate-700 dark:text-slate-200 pt-2 border-t border-slate-300 dark:border-slate-600 mt-3">Nährstoffzusammensetzung</h3> <p className="text-xs text-slate-500 dark:text-slate-400 -mt-2 mb-1">Flüssig: g/L. Pulver: %.</p>
                      <div className="grid grid-cols-2 sm:grid-cols-3 gap-2"> {NUTRIENT_FIELDS.map(field => ( <div key={field.key}> <label htmlFor={`custom_${field.key}`} className="block text-[0.7rem] font-medium text-slate-500 dark:text-slate-400 mb-0.5">{field.label}</label> <input type="number" id={`custom_${field.key}`} name={field.key} value={fertilizerFormState.composition[field.key]} onChange={handleCustomFertilizerCompositionChange} step="0.01" min="0" className={`${commonInputClasses} text-xs`}/> </div> ))} </div>
                      <button type="submit" className={`${commonButtonClasses} mt-1`}> {editingFertilizerId ? <><Save className="w-4 h-4" /> Speichern</> : <><Plus className="w-4 h-4" /> Hinzufügen</>} </button>
                      {editingFertilizerId && ( <button type="button" onClick={resetCustomFertilizerForm} className={`${commonButtonClasses} bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 mt-1`}> <XCircle className="w-4 h-4" /> Abbrechen </button> )}
                    </form>
                  </div>
                  <div className="space-y-3">
                    <h2 className={commonTitleClasses}><Beaker className="w-4 h-4" />Meine Dünger ({(customFertilizers || []).length})</h2>
                    {(customFertilizers || []).length === 0 ? ( <p className="text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">Noch keine eigenen Dünger erstellt.</p> ) : (
                      <div className="space-y-2 max-h-[450px] lg:max-h-[calc(100vh-300px)] overflow-y-auto bg-slate-100 dark:bg-slate-900/50 p-2 rounded-lg border border-slate-200 dark:border-slate-700">
                        {(customFertilizers || []).map(fert => ( 
                          <div key={fert.id} className="p-2 border bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-md shadow-sm">
                            <div className="flex items-start justify-between mb-1"> <div> <h4 className="font-semibold text-sm text-slate-800 dark:text-slate-100">{fert.name} <span className="text-xs font-normal text-slate-500 dark:text-slate-400">({fert.type}, {fert.unit})</span></h4> {fert.description && <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{fert.description}</p>} </div> <div className="flex"> <button onClick={() => handleStartEditCustomFertilizer(fert.id)} className="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 flex-shrink-0" title="Bearbeiten"> <Edit className="w-3.5 h-3.5" /> </button> <button onClick={() => handleDeleteCustomFertilizer(fert.id)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 flex-shrink-0" title="Löschen"> <Trash2 className="w-3.5 h-3.5" /> </button> </div> </div>
                            <div className="text-xs text-slate-600 dark:text-slate-300 grid grid-cols-2 sm:grid-cols-3 gap-x-2 gap-y-0.5"> {Object.entries(fert.composition || {}).map(([key, value]) => { if (Number(value) > 0) return <span key={key} className="truncate">{key.toUpperCase()}: {Number(value).toFixed(2)} {fert.type === 'liquid' ? 'g/L' : '%'}</span>; return null; })} </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}
              {activeTab === TAB_SETTINGS && (
                <div className="space-y-4">
                  <h2 className={commonTitleClasses}><Settings className="w-4 h-4" />Einstellungen</h2>
                  <div className={commonContainerClasses}>
                    <div className="space-y-3">
                      <div>
                        <label htmlFor="apiKeyInput" className={commonLabelClasses}>Google Gemini API Key</label>
                        <div className="flex gap-2">
                          <input
                            type="password"
                            id="apiKeyInput"
                            value={apiKey}
                            onChange={(e) => {
                              const newKey = e.target.value;
                              setApiKey(newKey);
                              localStorage.setItem(LOCAL_STORAGE_KEY_GEMINI_API_KEY, newKey);
                              addToast("API Key gespeichert", "success");
                            }}
                            className={commonInputClasses}
                            placeholder="API Key eingeben..."
                          />
                          <button
                            onClick={() => {
                              localStorage.removeItem(LOCAL_STORAGE_KEY_GEMINI_API_KEY);
                              setApiKey('');
                              addToast("API Key entfernt", "info");
                            }}
                            className="px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 flex items-center justify-center gap-1.5 text-sm"
                          >
                            <Trash2 className="w-4 h-4" /> Entfernen
                          </button>
                        </div>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                          API Key von <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">Google AI Studio</a> erforderlich.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };
        
        ReactDOM.render(
          <ThemeProvider>
            <ToastProviderInternal>
              <AdvancedNutrientCalculator />
            </ToastProviderInternal>
          </ThemeProvider>,
          document.getElementById('root')
        );

        const ReferencesSection = () => {
          const [open, setOpen] = React.useState(false);
          return (
            <div className="bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg p-3">
              <button onClick={() => setOpen(o => !o)} className="font-semibold text-blue-700 dark:text-blue-300 flex items-center gap-1 text-sm focus:outline-none">
                <Info className="w-4 h-4" />Quellen & Literatur {open ? '▲' : '▼'}
              </button>
              {open && (
                <ul className="mt-2 text-xs text-slate-700 dark:text-slate-200 space-y-1 list-disc list-inside">
                  <li>J. Benton Jones Jr., <em>Hydroponics: A Practical Guide for the Soilless Grower</em></li>
                  <li>Mills, H.A. & Jones, J.B. (1996). <em>Plant Analysis Handbook II</em></li>
                  <li>Smart Fertilizer: Plant Nutrient Deficiency Guide (<a href="https://www.smart-fertilizer.com/articles/plant-nutrient-deficiency-guide/" target="_blank" rel="noopener noreferrer" className="underline text-blue-600 dark:text-blue-400">Link</a>)</li>
                  <li>Royal Society of Chemistry: <em>Essential Nutrients for Plants</em></li>
                  <li>Peer-reviewed articles and reputable horticultural resources</li>
                </ul>
              )}
            </div>
          );
        };
    </script>
</body>
</html>